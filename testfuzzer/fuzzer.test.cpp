#include <iostream>

#include "gtest/gtest.h"
#include <libfuzzer/Fuzzer.h>
#include <libfuzzer/Util.h>
#include <libfuzzer/ContractABI.h>

using namespace fuzzer;
using namespace std;

TEST(Fuzzer, DISABLED_hasNewBits)
{
  bytes code;
  ContractABI ca;
  Fuzzer fuzzer(code, ca);
  bytes tracebits0(MAP_SIZE, 0);
  bytes tracebits1(MAP_SIZE, 0);
  bytes tracebits2(MAP_SIZE, 0);
  bytes tracebits3(MAP_SIZE, 0);
  tracebits1[10] = 1;
  tracebits2[10] = 100;
  tracebits3[1] = 2;
  EXPECT_EQ(fuzzer.hasNewBits(tracebits0), 0);
  // Hit new branches
  EXPECT_EQ(fuzzer.hasNewBits(tracebits1), 2);
  // No new branches
  EXPECT_EQ(fuzzer.hasNewBits(tracebits1), 0);
  // Hit again but more than prev tracebits1
  EXPECT_EQ(fuzzer.hasNewBits(tracebits2), 1);
  // Hit new branches
  EXPECT_EQ(fuzzer.hasNewBits(tracebits3), 2);
}
TEST(fuzzer, DISABLED_dynamic) {
  bytes code = fromHex("60806040526000805534801561001457600080fd5b506040516020806103168339810180604052810190808051906020019092919050505080600081905550506102c88061004e6000396000f30060806040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063026294a71461005157806319c8a93c14610133575b600080fd5b34801561005d57600080fd5b506100b8600480360381019080803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192905050506101c4565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156100f85780820151818401526020810190506100dd565b50505050905090810190601f1680156101255780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561013f57600080fd5b506101ae6004803603810190808035906020019092919080359060200190929190803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192905050506101ce565b6040518082815260200191505060405180910390f35b6060819050919050565b6000600a82511115610202577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff9050610295565b8284131561023157600060028581151561021857fe5b0714156102285760009050610295565b60019050610295565b8383131561026057600060028481151561024757fe5b0714156102575760009050610295565b60029050610295565b8284141561028f57600060028581151561027657fe5b0714156102865760039050610295565b60049050610295565b60005490505b93925050505600a165627a7a72305820c7639ecacb1b4a0474bf5c1f61f8285014bd4733fb0272cf2561f8ec50f174460029");
  string abiJson = "[{\"constant\":false,\"inputs\":[{\"name\":\"a\",\"type\":\"string\"}],\"name\":\"len\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"a\",\"type\":\"int256\"},{\"name\":\"b\",\"type\":\"int256\"},{\"name\":\"name\",\"type\":\"string\"}],\"name\":\"add\",\"outputs\":[{\"name\":\"\",\"type\":\"int256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"name\":\"init\",\"type\":\"int256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"}]";
  ContractABI ca(abiJson);
  Fuzzer fuzzer(code, ca);
  fuzzer.start();
}

TEST(Fuzzer, DISABLED_start_static) {
  bytes code = fromHex("60806040526000805534801561001457600080fd5b506040516020806101a68339810180604052810190808051906020019092919050505080600081905550506101588061004e6000396000f300608060405260043610610041576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063a5f3c23b14610046575b600080fd5b34801561005257600080fd5b5061007b6004803603810190808035906020019092919080359060200190929190505050610091565b6040518082815260200191505060405180910390f35b6000818313156100c25760006002848115156100a957fe5b0714156100b95760009050610126565b60019050610126565b828213156100f15760006002838115156100d857fe5b0714156100e85760009050610126565b60029050610126565b8183141561012057600060028481151561010757fe5b0714156101175760039050610126565b60049050610126565b60005490505b929150505600a165627a7a7230582049191804b62fc1bc3b034998fdb1840907690dd09bdace0268e759ea49e101f30029");
  string abiJson = "[{\"constant\":false,\"inputs\":[{\"name\":\"a\",\"type\":\"int256\"},{\"name\":\"b\",\"type\":\"int256\"}],\"name\":\"add\",\"outputs\":[{\"name\":\"\",\"type\":\"int256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"name\":\"init\",\"type\":\"int256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"}]";
  ContractABI ca(abiJson);
  Fuzzer fuzzer(code, ca);
  fuzzer.start();
}
